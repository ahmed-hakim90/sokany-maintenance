<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المخزون متعدد المراكز</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            margin: 0;
            padding: 20px;
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        h1, h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
        }
        
        h1 {
            padding: 15px;
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            color: white;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background-color: #fff;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        input, select, button, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            transition: all 0.3s ease;
            padding: 14px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        button.export {
            background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
        }
        
        button.import {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        
        button.admin {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
        }
        
        button.delete {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            overflow: hidden;
        }
        
        th, td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            font-weight: bold;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #f1f9ff;
        }
        
        .success {
            color: #27ae60;
            font-weight: bold;
        }
        
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .inventory-summary {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            color: white;
        }
        
        .summary-item {
            text-align: center;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        .summary-item h3 {
            margin: 0;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .summary-item p {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #3498db;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 25px;
            cursor: pointer;
            background-color: #f2f2f2;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            margin-left: 5px;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .maintenance-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-waiting-part {
            background-color: #ffeaa7;
            color: #d35400;
        }
        
        .status-waiting-technician {
            background-color: #81ecec;
            color: #00b894;
        }
        
        .status-completed {
            background-color: #55efc4;
            color: #00b894;
        }
        
        .status-waiting-customer {
            background-color: #fab1a0;
            color: #e17055;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .action-buttons button {
            padding: 8px 12px;
            font-size: 14px;
        }
        
        .export-options {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .export-options button {
            width: auto;
            padding: 12px 20px;
        }
        
        .login-container {
            max-width: 500px;
            margin: 50px auto;
            padding: 30px;
            background: linear-gradient(135deg, #ffffff 0%, #f5f7fa 100%);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .center-name {
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            color: white;
            padding: 15px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: bold;
            font-size: 20px;
        }
        
        .admin-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .admin-card {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #ddd;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }
        
        .center-select {
            margin-bottom: 20px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }
        
        .notification.success {
            background-color: #27ae60;
        }
        
        .notification.error {
            background-color: #e74c3c;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .chart-container {
            width: 100%;
            height: 400px;
            margin: 20px 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card h3 {
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .stat-card p {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
        }
        
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                margin-bottom: 5px;
                border-radius: 8px;
                margin-left: 0;
            }
            
            .inventory-summary {
                grid-template-columns: 1fr;
            }
            
            .export-options {
                flex-direction: column;
            }
            
            .export-options button {
                width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <!-- Firebase App (الجزء الأساسي من Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore-compat.js"></script>
    <!-- Firebase Authentication -->
    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-auth-compat.js"></script>
</head>
<body>
    <div id="notification" class="notification"></div>
    
    <div id="login-page" class="login-container">
        <h1><i class="fas fa-warehouse"></i> نظام إدارة المخزون متعدد المراكز</h1>
        <div class="form-group">
            <label for="center-select"><i class="fas fa-building"></i> اختر المركز:</label>
            <select id="center-select">
                <option value="">-- اختر المركز --</option>
                <option value="admin">لوحة المسؤول</option>
            </select>
        </div>
        <div class="form-group">
            <label for="email"><i class="fas fa-envelope"></i> البريد الإلكتروني:</label>
            <input type="email" id="email" placeholder="أدخل البريد الإلكتروني">
        </div>
        <div class="form-group">
            <label for="password"><i class="fas fa-lock"></i> كلمة المرور:</label>
            <input type="password" id="password" placeholder="أدخل كلمة المرور">
        </div>
        <button onclick="login()"><i class="fas fa-sign-in-alt"></i> تسجيل الدخول</button>
    </div>

    <div id="app-container" class="container" style="display: none;">
        <div id="center-header" class="center-name">المركز الرئيسي</div>
        
        <div class="inventory-summary">
            <div class="summary-item">
                <h3><i class="fas fa-boxes"></i> إجمالي الأصناف</h3>
                <p id="total-items">0</p>
            </div>
            <div class="summary-item">
                <h3><i class="fas fa-cubes"></i> إجمالي الكمية</h3>
                <p id="total-quantity">0</p>
            </div>
            <div class="summary-item">
                <h3><i class="fas fa-money-bill-wave"></i> القيمة الإجمالية</h3>
                <p id="total-value">0 جنيه</p>
            </div>
            <div class="summary-item">
                <h3><i class="fas fa-shopping-cart"></i> عمليات البيع</h3>
                <p id="total-sales">0</p>
            </div>
            <div class="summary-item">
                <h3><i class="fas fa-tools"></i> طلبات الصيانة</h3>
                <p id="total-maintenance">0</p>
            </div>
            <div class="summary-item">
                <h3><i class="fas fa-chart-line"></i> قيمة المبيعات</h3>
                <p id="total-sales-value">0 جنيه</p>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('inventory-tab')"><i class="fas fa-box-open"></i> إدارة المخزون</div>
            <div class="tab" onclick="switchTab('sales-tab')"><i class="fas fa-shopping-cart"></i> عمليات البيع</div>
            <div class="tab" onclick="switchTab('maintenance-tab')"><i class="fas fa-tools"></i> طلبات الصيانة</div>
            <div class="tab" onclick="switchTab('settings-tab')"><i class="fas fa-cog"></i> الإعدادات</div>
            <div class="tab" onclick="logout()"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</div>
        </div>
        
        <div id="inventory-tab" class="tab-content active">
            <div class="section">
                <h2><i class="fas fa-plus-circle"></i> إضافة صنف جديد</h2>
                <div class="form-group">
                    <label for="item-name">اسم الصنف:</label>
                    <input type="text" id="item-name" placeholder="أدخل اسم الصنف">
                </div>
                <div class="form-group">
                    <label for="initial-quantity">الكمية الأولية:</label>
                    <input type="number" id="initial-quantity" placeholder="أدخل الكمية" min="0">
                </div>
                <div class="form-group">
                    <label for="item-price">سعر الوحدة (جنيه):</label>
                    <input type="number" id="item-price" placeholder="أدخل السعر" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label for="item-note">ملاحظات:</label>
                    <textarea id="item-note" placeholder="أدخل أي ملاحظات حول الصنف"></textarea>
                </div>
                <button onclick="addNewItem()"><i class="fas fa-plus"></i> إضافة صنف جديد</button>
            </div>
            
            <div class="section">
                <h2><i class="fas fa-cart-plus"></i> إضافة إلى المخزون</h2>
                <div class="form-group">
                    <label for="add-item">اختر الصنف:</label>
                    <select id="add-item">
                        <option value="">-- اختر صنف --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="add-quantity">الكمية المضافة:</label>
                    <input type="number" id="add-quantity" placeholder="أدخل الكمية المضافة" min="1">
                </div>
                <div class="form-group">
                    <label for="add-note">ملاحظات:</label>
                    <textarea id="add-note" placeholder="أدخل أي ملاحظات حول الإضافة"></textarea>
                </div>
                <button onclick="addToInventory()"><i class="fas fa-plus"></i> إضافة إلى المخزون</button>
            </div>
            
            <div class="section">
                <h2><i class="fas fa-list"></i> قائمة الأصناف</h2>
                <table id="items-table">
                    <thead>
                        <tr>
                            <th>اسم الصنف</th>
                            <th>الكمية</th>
                            <th>السعر</th>
                            <th>القيمة</th>
                            <th>ملاحظات</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="sales-tab" class="tab-content">
            <div class="section">
                <h2><i class="fas fa-cash-register"></i> تسجيل عملية بيع</h2>
                <div class="form-group">
                    <label for="sale-item">اختر الصنف:</label>
                    <select id="sale-item">
                        <option value="">-- اختر صنف --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sale-quantity">كمية البيع:</label>
                    <input type="number" id="sale-quantity" placeholder="أدخل كمية البيع" min="1">
                </div>
                <div class="form-group">
                    <label for="customer-name">اسم العميل:</label>
                    <input type="text" id="customer-name" placeholder="أدخل اسم العميل">
                </div>
                <div class="form-group">
                    <label for="customer-phone">رقم تليفون العميل:</label>
                    <input type="text" id="customer-phone" placeholder="أدخل رقم التليفون">
                </div>
                <button onclick="recordSale()"><i class="fas fa-check"></i> تسجيل البيع</button>
            </div>
            
            <div class="section">
                <h2><i class="fas fa-history"></i> سجل عمليات البيع</h2>
                <table id="sales-table">
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>الصنف</th>
                            <th>الكمية</th>
                            <th>السعر</th>
                            <th>الإجمالي</th>
                            <th>اسم العميل</th>
                            <th>رقم التليفون</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="maintenance-tab" class="tab-content">
            <div class="section">
                <h2><i class="fas fa-tools"></i> تسجيل عملية صيانة</h2>
                <div class="form-group">
                    <label for="maintenance-item">اختر الصنف:</label>
                    <select id="maintenance-item">
                        <option value="">-- اختر صنف --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="maintenance-quantity">الكمية المستخدمة في الصيانة:</label>
                    <input type="number" id="maintenance-quantity" placeholder="أدخل الكمية" min="1">
                </div>
                <div class="form-group">
                    <label for="maintenance-customer-name">اسم العميل:</label>
                    <input type="text" id="maintenance-customer-name" placeholder="أدخل اسم العميل">
                </div>
                <div class="form-group">
                    <label for="maintenance-customer-phone">رقم تليفون العميل:</label>
                    <input type="text" id="maintenance-customer-phone" placeholder="أدخل رقم التليفون">
                </div>
                <div class="form-group">
                    <label for="device-name">اسم الجهاز:</label>
                    <input type="text" id="device-name" placeholder="أدخل اسم الجهاز">
                </div>
                <div class="form-group">
                    <label for="technician-select">الفني المسؤول:</label>
                    <select id="technician-select">
                        <option value="">-- اختر الفني --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="maintenance-status">حالة طلب الصيانة:</label>
                    <select id="maintenance-status">
                        <option value="في انتظار قطعة غيار">في انتظار قطعة غيار</option>
                        <option value="في انتظار الفني">في انتظار الفني</option>
                        <option value="تم الصيانة">تم الصيانة</option>
                        <option value="في انتظار العميل">في انتظار العميل</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="maintenance-note">ملاحظات الصيانة:</label>
                    <textarea id="maintenance-note" placeholder="أدخل ملاحظات الصيانة"></textarea>
                </div>
                <button onclick="recordMaintenance()"><i class="fas fa-check"></i> تسجيل الصيانة</button>
            </div>
            
            <div class="section">
                <h2><i class="fas fa-history"></i> سجل طلبات الصيانة</h2>
                <table id="maintenance-table">
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>الصنف</th>
                            <th>الكمية</th>
                            <th>العميل</th>
                            <th>الجهاز</th>
                            <th>الفني</th>
                            <th>الحالة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="settings-tab" class="tab-content">
            <div class="section">
                <h2><i class="fas fa-cog"></i> إعدادات المركز</h2>
                <div class="form-group">
                    <label for="settings-center-name">اسم المركز:</label>
                    <input type="text" id="settings-center-name" placeholder="اسم المركز">
                </div>
                <div class="form-group">
                    <label for="settings-center-email">البريد الإلكتروني:</label>
                    <input type="email" id="settings-center-email" placeholder="البريد الإلكتروني">
                </div>
                <div class="form-group">
                    <label for="settings-center-password">كلمة المرور الجديدة:</label>
                    <input type="password" id="settings-center-password" placeholder="كلمة المرور الجديدة">
                </div>
                <div class="form-group">
                    <label for="settings-confirm-password">تأكيد كلمة المرور:</label>
                    <input type="password" id="settings-confirm-password" placeholder="تأكيد كلمة المرور">
                </div>
                <button onclick="updateCenterSettings()"><i class="fas fa-save"></i> حفظ الإعدادات</button>
            </div>
        </div>
    </div>

    <div id="admin-container" class="container" style="display: none;">
        <h1><i class="fas fa-user-cog"></i> لوحة تحكم المسؤول</h1>
        <div class="tabs">
            <div class="tab active" onclick="switchAdminTab('centers-tab')"><i class="fas fa-building"></i> إدارة المراكز</div>
            <div class="tab" onclick="switchAdminTab('technicians-tab')"><i class="fas fa-user-cog"></i> إدارة الفنيين</div>
            <div class="tab" onclick="switchAdminTab('view-data-tab')"><i class="fas fa-database"></i> عرض بيانات المراكز</div>
            <div class="tab" onclick="switchAdminTab('export-tab')"><i class="fas fa-file-export"></i> التصدير والاستيراد</div>
            <div class="tab" onclick="logout()"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</div>
        </div>
        
        <div id="centers-tab" class="tab-content active">
            <div class="section">
                <h2><i class="fas fa-plus-circle"></i> إضافة مركز جديد</h2>
                <div class="form-group">
                    <label for="new-center-name">اسم المركز:</label>
                    <input type="text" id="new-center-name" placeholder="أدخل اسم المركز">
                </div>
                <div class="form-group">
                    <label for="new-center-email">البريد الإلكتروني:</label>
                    <input type="email" id="new-center-email" placeholder="أدخل البريد الإلكتروني">
                </div>
                <div class="form-group">
                    <label for="new-center-password">كلمة مرور المركز:</label>
                    <input type="password" id="new-center-password" placeholder="أدخل كلمة المرور">
                </div>
                <button onclick="addNewCenter()"><i class="fas fa-plus"></i> إضافة مركز جديد</button>
            </div>
            
            <div class="section">
                <h2><i class="fas fa-list"></i> قائمة المراكز</h2>
                <table id="centers-table">
                    <thead>
                        <tr>
                            <th>اسم المركز</th>
                            <th>البريد الإلكتروني</th>
                            <th>كلمة المرور</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="technicians-tab" class="tab-content">
            <div class="section">
                <h2><i class="fas fa-users-cog"></i> إضافة فني جديد</h2>
                <div class="form-group">
                    <label for="technician-name">اسم الفني:</label>
                    <input type="text" id="technician-name" placeholder="أدخل اسم الفني">
                </div>
                <div class="form-group">
                    <label for="technician-phone">رقم الهاتف:</label>
                    <input type="text" id="technician-phone" placeholder="أدخل رقم الهاتف">
                </div>
                <div class="form-group">
                    <label for="technician-address">العنوان:</label>
                    <textarea id="technician-address" placeholder="أدخل عنوان الفني"></textarea>
                </div>
                <div class="form-group">
                    <label for="technician-centers">المراكز التي يعمل بها:</label>
                    <select id="technician-centers" multiple>
                        <option value="">-- اختر المراكز --</option>
                    </select>
                    <small>اضغط زر Ctrl لاختيار أكثر من مركز</small>
                </div>
                <button onclick="addTechnician()"><i class="fas fa-plus"></i> إضافة فني</button>
            </div>
            
            <div class="section">
                <h2><i class="fas fa-list"></i> جميع الفنيين في النظام</h2>
                <table id="all-technicians-table">
                    <thead>
                        <tr>
                            <th>اسم الفني</th>
                            <th>رقم الهاتف</th>
                            <th>العنوان</th>
                            <th>المراكز</th>
                            <th>عدد أعمال الصيانة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="view-data-tab" class="tab-content">
            <div class="section">
                <h2><i class="fas fa-database"></i> عرض بيانات المراكز</h2>
                <div class="form-group center-select">
                    <label for="admin-center-select">اختر المركز:</label>
                    <select id="admin-center-select">
                        <option value="">-- اختر المركز --</option>
                        <option value="all">جميع المراكز</option>
                    </select>
                </div>
                
                <div id="center-stats">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3><i class="fas fa-boxes"></i> إجمالي الأصناف</h3>
                            <p id="admin-total-items">0</p>
                        </div>
                        <div class="stat-card">
                            <h3><i class="fas fa-cubes"></i> إجمالي الكمية</h3>
                            <p id="admin-total-quantity">0</p>
                        </div>
                        <div class="stat-card">
                            <h3><i class="fas fa-money-bill-wave"></i> القيمة الإجمالية</h3>
                            <p id="admin-total-value">0 جنيه</p>
                        </div>
                        <div class="stat-card">
                            <h3><i class="fas fa-shopping-cart"></i> عمليات البيع</h3>
                            <p id="admin-total-sales">0</p>
                        </div>
                        <div class="stat-card">
                            <h3><i class="fas fa-tools"></i> طلبات الصيانة</h3>
                            <p id="admin-total-maintenance">0</p>
                        </div>
                        <div class="stat-card">
                            <h3><i class="fas fa-chart-line"></i> قيمة المبيعات</h3>
                            <p id="admin-total-sales-value">0 جنيه</p>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="sales-chart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="inventory-chart"></canvas>
                    </div>
                </div>
                
                <div class="tabs">
                    <div class="tab active" onclick="switchCenterDataTab('center-inventory-tab')">المخزون</div>
                    <div class="tab" onclick="switchCenterDataTab('center-sales-tab')">المبيعات</div>
                    <div class="tab" onclick="switchCenterDataTab('center-maintenance-tab')">الصيانة</div>
                </div>
                
                <div id="center-inventory-tab" class="tab-content active">
                    <table id="admin-items-table">
                        <thead>
                            <tr>
                                <th>اسم الصنف</th>
                                <th>الكمية</th>
                                <th>السعر</th>
                                <th>القيمة</th>
                                <th>ملاحظات</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
                
                <div id="center-sales-tab" class="tab-content">
                    <table id="admin-sales-table">
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>الصنف</th>
                                <th>الكمية</th>
                                <th>السعر</th>
                                <th>الإجمالي</th>
                                <th>اسم العميل</th>
                                <th>رقم التليفون</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
                
                <div id="center-maintenance-tab" class="tab-content">
                    <table id="admin-maintenance-table">
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>الصنف</th>
                                <th>الكمية</th>
                                <th>العميل</th>
                                <th>الجهاز</th>
                                <th>الفني</th>
                                <th>الحالة</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
       <div id="export-tab" class="tab-content">
    <div class="section">
        <h2><i class="fas fa-file-export"></i> تصدير البيانات</h2>
        <div class="form-group">
            <label for="export-scope">نطاق التصدير:</label>
            <select id="export-scope">
                <option value="all">جميع المراكز</option>
                <option value="selected">المركز المحدد فقط</option>
            </select>
        </div>
        <div class="export-options">
            <button class="export" onclick="exportData('all')"><i class="fas fa-download"></i> تصدير جميع البيانات</button>
            <button class="export" onclick="exportData('inventory')"><i class="fas fa-download"></i> تصدير الأصناف</button>
            <button class="export" onclick="exportData('sales')"><i class="fas fa-download"></i> تصدير عمليات البيع</button>
            <button class="export" onclick="exportData('maintenance')"><i class="fas fa-download"></i> تصدير طلبات الصيانة</button>
        </div>
    </div>
    
    <div class="section">
        <h2><i class="fas fa-file-import"></i> استيراد البيانات</h2>
        <div class="form-group">
            <label for="import-file">اختر ملف البيانات:</label>
            <input type="file" id="import-file" accept=".json,.csv">
        </div>
        <div class="form-group">
            <label for="import-type">نوع البيانات:</label>
            <select id="import-type">
                <option value="inventory">الأصناف</option>
                <option value="sales">عمليات البيع</option>
                <option value="maintenance">طلبات الصيانة</option>
            </select>
        </div>
        <div class="form-group">
            <label for="import-scope">نطاق الاستيراد:</label>
            <select id="import-scope">
                <option value="selected">المركز المحدد</option>
                <option value="all">جميع المراكز (حسب البيانات)</option>
            </select>
        </div>
        <button class="import" onclick="importData()"><i class="fas fa-upload"></i> استيراد البيانات</button>
    </div>
</div>

    <script>
        // تهيئة Firebase - استبدل هذه القيم ببيانات مشروعك من Firebase Console
        const firebaseConfig = {
            apiKey: "AIzaSyA8THKyWr50bcGWOd7MHFpPqlBE4gvp6Hk",
            authDomain: "main-maintenance.firebaseapp.com",
            projectId: "main-maintenance",
            storageBucket: "main-maintenance.appspot.com",
            messagingSenderId: "806089947936",
            appId: "1:806089947936:web:90af1597a0a8a558fe3545"
        };
        
        // تهيئة Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // بيانات التخزين
        let centers = [];
        let technicians = [];
        let currentCenter = null;
        let isAdmin = false;
        const adminPassword = "admin123"; // كلمة مرور المسؤول الافتراضية
        
        // أسماء الكولكشن في Firebase
        const CENTERS_COLLECTION = "centers";
        const INVENTORY_COLLECTION = "inventory";
        const SALES_COLLECTION = "sales";
        const MAINTENANCE_COLLECTION = "maintenance";
        const TECHNICIANS_COLLECTION = "technicians";
        
        // متغيرات للرسوم البيانية
        let salesChart = null;
        let inventoryChart = null;
        
        // تهيئة الصفحة
        function initializePage() {
            // تحميل بيانات المراكز من Firebase
            loadCentersFromFirebase();
            loadTechniciansFromFirebase();
            
            // إذا كان هناك مركز مسجل مسبقاً، تخطي صفحة التسجيل
            const savedCenter = localStorage.getItem('currentCenter');
            if (savedCenter) {
                currentCenter = JSON.parse(savedCenter);
                showApp();
            }
        }
        
        // تحميل المراكز من Firebase
        async function loadCentersFromFirebase() {
            try {
                showNotification('جاري تحميل البيانات...', 'success');
                const snapshot = await db.collection(CENTERS_COLLECTION).get();
                centers = [];
                snapshot.forEach(doc => {
                    centers.push({ id: doc.id, ...doc.data() });
                });
                
                // تحديث واجهة المستخدم
                updateCenterSelects();
                updateTechnicianCenterSelect();
                showNotification('تم تحميل البيانات بنجاح', 'success');
            } catch (error) {
                console.error('Error loading centers:', error);
                showNotification('حدث خطأ في تحميل بيانات المراكز', 'error');
            }
        }
        
        // تحميل الفنيين من Firebase
        async function loadTechniciansFromFirebase() {
            try {
                const snapshot = await db.collection(TECHNICIANS_COLLECTION).get();
                technicians = [];
                snapshot.forEach(doc => {
                    technicians.push({ id: doc.id, ...doc.data() });
                });
                
                // تحديث واجهة المستخدم
                updateTechnicianSelects();
                updateAllTechniciansTable();
            } catch (error) {
                console.error('Error loading technicians:', error);
                showNotification('حدث خطأ في تحميل بيانات الفنيين', 'error');
            }
        }
        
        // تحديث قوائم اختيار المراكز
        function updateCenterSelects() {
            const centerSelect = document.getElementById('center-select');
            const adminCenterSelect = document.getElementById('admin-center-select');
            
            // مسح القوائم الحالية
            centerSelect.innerHTML = '<option value="">-- اختر المركز --</option>';
            adminCenterSelect.innerHTML = '<option value="">-- اختر المركز --</option><option value="all">جميع المراكز</option>';
            
            // إضافة خيار لوحة المسؤول
            const adminOption = document.createElement('option');
            adminOption.value = 'admin';
            adminOption.textContent = 'لوحة المسؤول';
            centerSelect.appendChild(adminOption);
            
            // إضافة المراكز إلى القوائم
            centers.forEach(center => {
                const option = document.createElement('option');
                option.value = center.id;
                option.textContent = center.name;
                
                centerSelect.appendChild(option.cloneNode(true));
                adminCenterSelect.appendChild(option.cloneNode(true));
            });
            
            // تحديث جدول المراكز في لوحة المسؤول
            // updateCentersTable();
        }
        
        // تحديث قائمة المراكز للفنيين
        function updateTechnicianCenterSelect() {
            const technicianCenters = document.getElementById('technician-centers');
            
            // مسح القائمة الحالية
            technicianCenters.innerHTML = '<option value="">-- اختر المراكز --</option>';
            
            // إضافة المراكز إلى القائمة
            centers.forEach(center => {
                const option = document.createElement('option');
                option.value = center.id;
                option.textContent = center.name;
                technicianCenters.appendChild(option);
            });
        }
        
        // تحديث قوائم اختيار الفنيين
        function updateTechnicianSelects() {
            const technicianSelect = document.getElementById('technician-select');
            
            // مسح القائمة الحالية
            technicianSelect.innerHTML = '<option value="">-- اختر الفني --</option>';
            
            // إضافة الفنيين إلى القائمة
            technicians.forEach(tech => {
                const option = document.createElement('option');
                option.value = tech.id;
                option.textContent = tech.name;
                technicianSelect.appendChild(option);
            });
        }
        
        // تحميل بيانات مركز من Firebase
        async function loadCenterFromFirebase(centerId) {
            try {
                showNotification('جاري تحميل بيانات المركز...', 'success');
                const doc = await db.collection(CENTERS_COLLECTION).doc(centerId).get();
                if (doc.exists) {
                    currentCenter = { id: doc.id, ...doc.data() };
                    localStorage.setItem('currentCenter', JSON.stringify(currentCenter));
                    showApp();
                    showNotification('تم تحميل بيانات المركز بنجاح', 'success');
                } else {
                    showNotification('المركز غير موجود', 'error');
                }
            } catch (error) {
                console.error('Error loading center:', error);
                showNotification('حدث خطأ في تحميل بيانات المركز', 'error');
            }
        }
        
        // تسجيل الدخول
        async function login() {
            const centerSelect = document.getElementById('center-select');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const centerId = centerSelect.value;
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            
            if (!centerId) {
                showNotification('يرجى اختيار مركز', 'error');
                return;
            }
            
            if (!email) {
                showNotification('يرجى إدخال البريد الإلكتروني', 'error');
                return;
            }
            
            if (!password) {
                showNotification('يرجى إدخال كلمة المرور', 'error');
                return;
            }
            
            // دخول كمسؤول
            if (centerId === 'admin') {
                if (password === adminPassword) {
                    isAdmin = true;
                    showAdminPanel();
                    showNotification('تم الدخول كمسؤول', 'success');
                } else {
                    showNotification('كلمة مرور المسؤول غير صحيحة', 'error');
                }
                return;
            }
            
            // دخول كمركز عادي
            try {
                const center = centers.find(c => c.id === centerId);
                if (!center) {
                    showNotification('المركز غير موجود', 'error');
                    return;
                }
                
                if (center.email !== email || center.password !== password) {
                    showNotification('البريد الإلكتروني أو كلمة المرور غير صحيحة', 'error');
                    return;
                }
                
                loadCenterFromFirebase(center.id);
            } catch (error) {
                console.error('Login error:', error);
                showNotification('حدث خطأ أثناء تسجيل الدخول', 'error');
            }
        }
        // تسجيل الخروج
async function logout() {
    try {
        await auth.signOut();
        currentCenter = null;
        isAdmin = false;
        localStorage.removeItem('currentCenter');
        localStorage.removeItem('userData');
        
        document.getElementById('login-page').style.display = 'block';
        document.getElementById('app-container').style.display = 'none';
        document.getElementById('admin-container').style.display = 'none';
        
        // إعادة تعيين الحقول
        document.getElementById('email').value = '';
        document.getElementById('password').value = '';
        document.getElementById('center-select').selectedIndex = 0;
        
        showNotification('تم تسجيل الخروج بنجاح', 'success');
    } catch (error) {
        console.error('Logout error:', error);
        showNotification('حدث خطأ أثناء تسجيل الخروج', 'error');
    }
}
        
        // إضافة مركز جديد إلى Firebase
        async function addNewCenter() {
            const name = document.getElementById('new-center-name').value.trim();
            const email = document.getElementById('new-center-email').value.trim();
            const password = document.getElementById('new-center-password').value;
            
            if (!name || !email || !password) {
                showNotification('يرجى ملء جميع الحقول', 'error');
                return;
            }
            
            // التأكد من أن اسم المركز غير مكرر
            if (centers.some(center => center.name === name)) {
                showNotification('اسم المركز موجود مسبقاً', 'error');
                return;
            }
            
            try {
                showNotification('جاري إضافة المركز...', 'success');
                // إضافة مركز إلى Firestore
                const docRef = await db.collection(CENTERS_COLLECTION).add({
                    name: name,
                    email: email,
                    password: password,
                    inventory: [],
                    sales: [],
                    maintenance: []
                });
                
                // إعادة تعيين الحقول
                document.getElementById('new-center-name').value = '';
                document.getElementById('new-center-email').value = '';
                document.getElementById('new-center-password').value = '';
                
                // تحديث القوائم
                await loadCentersFromFirebase();
                
                showNotification('تم إضافة المركز بنجاح!', 'success');
            } catch (error) {
                console.error('Error adding center:', error);
                showNotification('حدث خطأ أثناء إضافة المركز', 'error');
            }
        }
        
        // إضافة فني جديد
        async function addTechnician() {
            const name = document.getElementById('technician-name').value.trim();
            const phone = document.getElementById('technician-phone').value.trim();
            const address = document.getElementById('technician-address').value.trim();
            const centersSelect = document.getElementById('technician-centers');
            const selectedCenters = Array.from(centersSelect.selectedOptions).map(option => option.value);
            const centerNames = Array.from(centersSelect.selectedOptions).map(option => option.text);
            
            if (!name || !phone) {
                showNotification('يرجى ملء جميع الحقول المطلوبة', 'error');
                return;
            }
            
            try {
                const technicianData = {
                    name: name,
                    phone: phone,
                    address: address,
                    centerIds: selectedCenters,
                    centerNames: centerNames,
                    maintenanceCount: 0
                };
                
                // إضافة الفني إلى Firestore
                await db.collection(TECHNICIANS_COLLECTION).add(technicianData);
                
                showNotification('تم إضافة الفني بنجاح', 'success');
                
                // إعادة تعيين الحقول
                document.getElementById('technician-name').value = '';
                document.getElementById('technician-phone').value = '';
                document.getElementById('technician-address').value = '';
                centersSelect.selectedIndex = -1;
                
                // تحديث البيانات
                await loadTechniciansFromFirebase();
            } catch (error) {
                console.error('Error adding technician:', error);
                showNotification('حدث خطأ أثناء إضافة الفني', 'error');
            }
        }
        
        // تحديث إعدادات المركز
        async function updateCenterSettings() {
            if (!currentCenter) return;
            
            const name = document.getElementById('settings-center-name').value.trim();
            const email = document.getElementById('settings-center-email').value.trim();
            const password = document.getElementById('settings-center-password').value;
            const confirmPassword = document.getElementById('settings-confirm-password').value;
            
            if (!name || !email) {
                showNotification('يرجى ملء جميع الحقول المطلوبة', 'error');
                return;
            }
            
            if (password && password !== confirmPassword) {
                showNotification('كلمة المرور غير متطابقة', 'error');
                return;
            }
            
            try {
                const updateData = {
                    name: name,
                    email: email
                };
                
                if (password) {
                    updateData.password = password;
                }
                
                // تحديث بيانات المركز في Firestore
                await db.collection(CENTERS_COLLECTION).doc(currentCenter.id).update(updateData);
                
                // تحديث البيانات المحلية
                currentCenter.name = name;
                currentCenter.email = email;
                if (password) {
                    currentCenter.password = password;
                }
                
                localStorage.setItem('currentCenter', JSON.stringify(currentCenter));
                
                // تحديث واجهة المستخدم
                document.getElementById('center-header').textContent = currentCenter.name;
                
                showNotification('تم تحديث إعدادات المركز بنجاح', 'success');
            } catch (error) {
                console.error('Error updating center settings:', error);
                showNotification('حدث خطأ أثناء تحديث الإعدادات', 'error');
            }
        }
        
        // تحميل بيانات الإعدادات
        function loadSettingsData() {
            if (!currentCenter) return;
            
            document.getElementById('settings-center-name').value = currentCenter.name || '';
            document.getElementById('settings-center-email').value = currentCenter.email || '';
            document.getElementById('settings-center-password').value = '';
            document.getElementById('settings-confirm-password').value = '';
        }
        
        // تحديث جدول جميع الفنيين (للمسؤول)
        function updateAllTechniciansTable() {
            const tbody = document.querySelector('#all-technicians-table tbody');
            tbody.innerHTML = '';
            
            technicians.forEach(tech => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${tech.name}</td>
                    <td>${tech.phone}</td>
                    <td>${tech.address || ''}</td>
                    <td>${tech.centerNames ? tech.centerNames.join(', ') : ''}</td>
                    <td>${tech.maintenanceCount || 0}</td>
                    <td class="action-buttons">
                        <button class="delete" onclick="deleteTechnician('${tech.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // حذف فني
        async function deleteTechnician(technicianId) {
            if (!confirm('هل أنت متأكد من حذف هذا الفني؟')) {
                return;
            }
            
            try {
                // حذف الفني من Firestore
                await db.collection(TECHNICIANS_COLLECTION).doc(technicianId).delete();
                
                // تحديث البيانات
                await loadTechniciansFromFirebase();
                
                showNotification('تم حذف الفني بنجاح', 'success');
            } catch (error) {
                console.error('Error deleting technician:', error);
                showNotification('حدث خطأ أثناء حذف الفني', 'error');
            }
        }
        
        // تحميل بيانات مركز للمسؤول
        async function loadCenterDataForAdmin(centerId) {
            try {
                let totalItems = 0;
                let totalQuantity = 0;
                let totalValue = 0;
                let totalSales = 0;
                let totalSalesValue = 0;
                let totalMaintenance = 0;
                
                let inventoryData = [];
                let salesData = [];
                let maintenanceData = [];
                
                if (centerId === "all") {
                    // تحميل بيانات جميع المراكز
                    for (const center of centers) {
                        const inventorySnapshot = await db.collection(CENTERS_COLLECTION).doc(center.id).collection(INVENTORY_COLLECTION).get();
                        const salesSnapshot = await db.collection(CENTERS_COLLECTION).doc(center.id).collection(SALES_COLLECTION).get();
                        const maintenanceSnapshot = await db.collection(CENTERS_COLLECTION).doc(center.id).collection(MAINTENANCE_COLLECTION).get();
                        
                        totalItems += inventorySnapshot.size;
                        totalQuantity += inventorySnapshot.docs.reduce((sum, doc) => sum + (doc.data().quantity || 0), 0);
                        totalValue += inventorySnapshot.docs.reduce((sum, doc) => {
                            const item = doc.data();
                            return sum + (item.quantity * item.price || 0);
                        }, 0);
                        
                        totalSales += salesSnapshot.size;
                        totalSalesValue += salesSnapshot.docs.reduce((sum, doc) => sum + (doc.data().totalPrice || 0), 0);
                        totalMaintenance += maintenanceSnapshot.size;
                        
                        // جمع البيانات للعرض في الجداول
                        inventorySnapshot.forEach(doc => {
                            inventoryData.push({ ...doc.data(), center: center.name });
                        });
                        
                        salesSnapshot.forEach(doc => {
                            salesData.push({ ...doc.data(), center: center.name });
                        });
                        
                        maintenanceSnapshot.forEach(doc => {
                            maintenanceData.push({ ...doc.data(), center: center.name });
                        });
                    }
                } else {
                    // تحميل بيانات مركز محدد
                    const centerDoc = await db.collection(CENTERS_COLLECTION).doc(centerId).get();
                    if (!centerDoc.exists) {
                        showNotification('المركز غير موجود', 'error');
                        return;
                    }
                    
                    const inventorySnapshot = await db.collection(CENTERS_COLLECTION).doc(centerId).collection(INVENTORY_COLLECTION).get();
                    const salesSnapshot = await db.collection(CENTERS_COLLECTION).doc(centerId).collection(SALES_COLLECTION).get();
                    const maintenanceSnapshot = await db.collection(CENTERS_COLLECTION).doc(centerId).collection(MAINTENANCE_COLLECTION).get();
                    
                    totalItems = inventorySnapshot.size;
                    totalQuantity = inventorySnapshot.docs.reduce((sum, doc) => sum + (doc.data().quantity || 0), 0);
                    totalValue = inventorySnapshot.docs.reduce((sum, doc) => {
                        const item = doc.data();
                        return sum + (item.quantity * item.price || 0);
                    }, 0);
                    
                    totalSales = salesSnapshot.size;
                    totalSalesValue = salesSnapshot.docs.reduce((sum, doc) => sum + (doc.data().totalPrice || 0), 0);
                    totalMaintenance = maintenanceSnapshot.size;
                    
                    // جمع البيانات للعرض في الجداول
                    inventorySnapshot.forEach(doc => {
                        inventoryData.push(doc.data());
                    });
                    
                    salesSnapshot.forEach(doc => {
                        salesData.push(doc.data());
                    });
                    
                    maintenanceSnapshot.forEach(doc => {
                        maintenanceData.push(doc.data());
                    });
                }
                
                // تحديث الإحصائيات
                document.getElementById('admin-total-items').textContent = totalItems;
                document.getElementById('admin-total-quantity').textContent = totalQuantity;
                document.getElementById('admin-total-value').textContent = totalValue.toFixed(2);
                document.getElementById('admin-total-sales').textContent = totalSales;
                document.getElementById('admin-total-sales-value').textContent = totalSalesValue.toFixed(2);
                document.getElementById('admin-total-maintenance').textContent = totalMaintenance;
                
                // تحديث الرسوم البيانية
                updateCharts(salesData, inventoryData);
                
                // تحديث جدول المخزون
                const inventoryTbody = document.querySelector('#admin-items-table tbody');
                inventoryTbody.innerHTML = '';
                
                inventoryData.forEach(item => {
                    const value = item.quantity * item.price;
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${item.name} ${item.center ? `(${item.center})` : ''}</td>
                        <td>${item.quantity}</td>
                        <td>${item.price.toFixed(2)} جنيه</td>
                        <td>${value.toFixed(2)} جنيه</td>
                        <td>${item.note || ''}</td>
                    `;
                    
                    inventoryTbody.appendChild(row);
                });
                
                // تحديث جدول المبيعات
                const salesTbody = document.querySelector('#admin-sales-table tbody');
                salesTbody.innerHTML = '';
                
                salesData.forEach(sale => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${new Date(sale.date).toLocaleString('ar-EG')}</td>
                        <td>${sale.itemName} ${sale.center ? `(${sale.center})` : ''}</td>
                        <td>${sale.quantity}</td>
                        <td>${sale.unitPrice.toFixed(2)} جنيه</td>
                        <td>${sale.totalPrice.toFixed(2)} جنيه</td>
                        <td>${sale.customerName}</td>
                        <td>${sale.customerPhone}</td>
                    `;
                    
                    salesTbody.appendChild(row);
                });
                
                // تحديث جدول الصيانة
                const maintenanceTbody = document.querySelector('#admin-maintenance-table tbody');
                maintenanceTbody.innerHTML = '';
                
                maintenanceData.forEach(maintenance => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${new Date(maintenance.date).toLocaleString('ar-EG')}</td>
                        <td>${maintenance.itemName} ${maintenance.center ? `(${maintenance.center})` : ''}</td>
                        <td>${maintenance.quantity}</td>
                        <td>${maintenance.customerName}<br>${maintenance.customerPhone}</td>
                        <td>${maintenance.deviceName}</td>
                        <td>${maintenance.technicianName}</td>
                        <td>${maintenance.status}</td>
                    `;
                    
                    maintenanceTbody.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error loading center data for admin:', error);
                showNotification('حدث خطأ في تحميل بيانات المركز', 'error');
            }
        }
        
        // تحديث الرسوم البيانية
        function updateCharts(salesData, inventoryData) {
            // تدمير الرسوم البيانية الحالية إذا كانت موجودة
            if (salesChart) {
                salesChart.destroy();
            }
            if (inventoryChart) {
                inventoryChart.destroy();
            }
            
            // تحضير بيانات المبيعات للرسم البياني
            const salesByDate = {};
            salesData.forEach(sale => {
                const date = new Date(sale.date).toLocaleDateString('ar-EG');
                salesByDate[date] = (salesByDate[date] || 0) + sale.totalPrice;
            });
            
            const salesDates = Object.keys(salesByDate);
            const salesValues = Object.values(salesByDate);
            
            // رسم بياني للمبيعات
            const salesCtx = document.getElementById('sales-chart').getContext('2d');
            salesChart = new Chart(salesCtx, {
                type: 'line',
                data: {
                    labels: salesDates,
                    datasets: [{
                        label: 'قيمة المبيعات بالجنيه',
                        data: salesValues,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'تطور المبيعات يومياً',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'قيمة المبيعات (جنيه)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'التاريخ'
                            }
                        }
                    }
                }
            });
            
            // تحضير بيانات المخزون للرسم البياني
            const inventoryValues = inventoryData.map(item => item.quantity * item.price);
            const inventoryNames = inventoryData.map(item => item.name);
            
            // رسم بياني للمخزون
            const inventoryCtx = document.getElementById('inventory-chart').getContext('2d');
            inventoryChart = new Chart(inventoryCtx, {
                type: 'bar',
                data: {
                    labels: inventoryNames,
                    datasets: [{
                        label: 'قيمة المخزون بالجنيه',
                        data: inventoryValues,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'قيمة الأصناف في المخزون',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'القيمة (جنيه)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'الأصناف'
                            }
                        }
                    }
                }
            });
        }
        
        // إضافة صنف جديد
        async function addNewItem() {
            if (!currentCenter) return;
            
            const name = document.getElementById('item-name').value.trim();
            const quantity = parseInt(document.getElementById('initial-quantity').value);
            const price = parseFloat(document.getElementById('item-price').value);
            const note = document.getElementById('item-note').value.trim();
            
            if (!name || isNaN(quantity) || quantity < 0 || isNaN(price) || price < 0) {
                showNotification('يرجى ملء جميع الحقول المطلوبة بشكل صحيح', 'error');
                return;
            }
            
            try {
                // التحقق من عدم وجود صنف بنفس الاسم
                const existingItems = await db.collection(CENTERS_COLLECTION)
                    .doc(currentCenter.id)
                    .collection(INVENTORY_COLLECTION)
                    .where('name', '==', name)
                    .get();
                
                if (!existingItems.empty) {
                    showNotification('يوجد بالفعل صنف بنفس الاسم', 'error');
                    return;
                }
                
                const newItem = {
                    id: Date.now().toString(),
                    name: name,
                    quantity: quantity,
                    price: price,
                    note: note,
                    createdAt: new Date(),
                    lastUpdated: new Date()
                };
                
                // إضافة الصنف إلى Firestore
                await db.collection(CENTERS_COLLECTION)
                    .doc(currentCenter.id)
                    .collection(INVENTORY_COLLECTION)
                    .doc(newItem.id)
                    .set(newItem);
                
                showNotification('تم إضافة الصنف بنجاح', 'success');
                
                // إعادة تعيين الحقول
                document.getElementById('item-name').value = '';
                document.getElementById('initial-quantity').value = '';
                document.getElementById('item-price').value = '';
                document.getElementById('item-note').value = '';
                
                // تحديث البيانات
                await loadCenterFromFirebase(currentCenter.id);
                
            } catch (error) {
                console.error('Error adding item:', error);
                showNotification('حدث خطأ أثناء إضافة الصنف', 'error');
            }
        }
        
        // إضافة إلى المخزون
        async function addToInventory() {
            if (!currentCenter) return;
            
            const itemId = document.getElementById('add-item').value;
            const quantity = parseInt(document.getElementById('add-quantity').value);
            const note = document.getElementById('add-note').value.trim();
            
            if (!itemId || isNaN(quantity) || quantity <= 0) {
                showNotification('يرجى اختيار صنف وإدخال كمية صحيحة', 'error');
                return;
            }
            
            try {
                // استخدام المعاملة لضمان التحديث الآمن
                await db.runTransaction(async (transaction) => {
                    const itemRef = db.collection(CENTERS_COLLECTION)
                        .doc(currentCenter.id)
                        .collection(INVENTORY_COLLECTION)
                        .doc(itemId);
                    
                    const itemDoc = await transaction.get(itemRef);
                    if (!itemDoc.exists) {
                        throw new Error('الصنف غير موجود');
                    }
                    
                    const currentQuantity = itemDoc.data().quantity || 0;
                    const newQuantity = currentQuantity + quantity;
                    
                    transaction.update(itemRef, {
                        quantity: newQuantity,
                        lastUpdated: new Date()
                    });
                });
                
                // تسجيل عملية الإضافة في السجل
                const addRecord = {
                    itemId: itemId,
                    quantity: quantity,
                    note: note,
                    date: new Date(),
                    type: 'add'
                };
                
                await db.collection(CENTERS_COLLECTION)
                    .doc(currentCenter.id)
                    .collection('inventoryLogs')
                    .add(addRecord);
                
                showNotification('تمت إضافة الكمية إلى المخزون بنجاح', 'success');
                
                // إعادة تعيين الحقول
                document.getElementById('add-item').value = '';
                document.getElementById('add-quantity').value = '';
                document.getElementById('add-note').value = '';
                
                // تحديث البيانات
                await loadCenterFromFirebase(currentCenter.id);
                
            } catch (error) {
                console.error('Error adding to inventory:', error);
                showNotification('حدث خطأ أثناء إضافة الكمية إلى المخزون', 'error');
            }
        }
        
        // تسجيل عملية بيع
        async function recordSale() {
            if (!currentCenter) return;
            
            const itemId = document.getElementById('sale-item').value;
            const quantity = parseInt(document.getElementById('sale-quantity').value);
            const customerName = document.getElementById('customer-name').value.trim();
            const customerPhone = document.getElementById('customer-phone').value.trim();
            
            if (!itemId || isNaN(quantity) || quantity <= 0 || !customerName) {
                showNotification('يرجى ملء جميع الحقول المطلوبة بشكل صحيح', 'error');
                return;
            }
            
            try {
                // استخدام المعاملة لضمان التحديث الآمن
                await db.runTransaction(async (transaction) => {
                    const itemRef = db.collection(CENTERS_COLLECTION)
                        .doc(currentCenter.id)
                        .collection(INVENTORY_COLLECTION)
                        .doc(itemId);
                    
                    const itemDoc = await transaction.get(itemRef);
                    if (!itemDoc.exists) {
                        throw new Error('الصنف غير موجود');
                    }
                    
                    const item = itemDoc.data();
                    if (item.quantity < quantity) {
                        throw new Error('الكمية المتاحة غير كافية');
                    }
                    
                    const newQuantity = item.quantity - quantity;
                    
                    transaction.update(itemRef, {
                        quantity: newQuantity,
                        lastUpdated: new Date()
                    });
                    
                    // تسجيل عملية البيع
                    const saleRecord = {
                        itemId: itemId,
                        itemName: item.name,
                        quantity: quantity,
                        unitPrice: item.price,
                        totalPrice: quantity * item.price,
                        customerName: customerName,
                        customerPhone: customerPhone,
                        date: new Date()
                    };
                    
                    transaction.set(
                        db.collection(CENTERS_COLLECTION)
                            .doc(currentCenter.id)
                            .collection(SALES_COLLECTION)
                            .doc(),
                        saleRecord
                    );
                });
                
                showNotification('تم تسجيل عملية البيع بنجاح', 'success');
                
                // إعادة تعيين الحقول
                document.getElementById('sale-item').value = '';
                document.getElementById('sale-quantity').value = '';
                document.getElementById('customer-name').value = '';
                document.getElementById('customer-phone').value = '';
                
                // تحديث البيانات
                await loadCenterFromFirebase(currentCenter.id);
                
            } catch (error) {
                console.error('Error recording sale:', error);
                showNotification(error.message || 'حدث خطأ أثناء تسجيل عملية البيع', 'error');
            }
        }
        
        // تسجيل عملية صيانة
        async function recordMaintenance() {
            if (!currentCenter) return;
            
            const itemId = document.getElementById('maintenance-item').value;
            const quantity = parseInt(document.getElementById('maintenance-quantity').value);
            const customerName = document.getElementById('maintenance-customer-name').value.trim();
            const customerPhone = document.getElementById('maintenance-customer-phone').value.trim();
            const deviceName = document.getElementById('device-name').value.trim();
            const technicianId = document.getElementById('technician-select').value;
            const status = document.getElementById('maintenance-status').value;
            const note = document.getElementById('maintenance-note').value.trim();
            
            if (!itemId || isNaN(quantity) || quantity <= 0 || !customerName || !deviceName || !technicianId) {
                showNotification('يرجى ملء جميع الحقول المطلوبة بشكل صحيح', 'error');
                return;
            }
            
            try {
                const technician = technicians.find(t => t.id === technicianId);
                if (!technician) {
                    showNotification('الفني غير موجود', 'error');
                    return;
                }
                
                // استخدام المعاملة لضمان التحديث الآمن
                await db.runTransaction(async (transaction) => {
                    const itemRef = db.collection(CENTERS_COLLECTION)
                        .doc(currentCenter.id)
                        .collection(INVENTORY_COLLECTION)
                        .doc(itemId);
                    
                    const itemDoc = await transaction.get(itemRef);
                    if (!itemDoc.exists) {
                        throw new Error('الصنف غير موجود');
                    }
                    
                    const item = itemDoc.data();
                    if (item.quantity < quantity) {
                        throw new Error('الكمية المتاحة غير كافية');
                    }
                    
                    const newQuantity = item.quantity - quantity;
                    
                    transaction.update(itemRef, {
                        quantity: newQuantity,
                        lastUpdated: new Date()
                    });
                    
                    // تسجيل عملية الصيانة
                    const maintenanceRecord = {
                        itemId: itemId,
                        itemName: item.name,
                        quantity: quantity,
                        customerName: customerName,
                        customerPhone: customerPhone,
                        deviceName: deviceName,
                        technicianId: technicianId,
                        technicianName: technician.name,
                        status: status,
                        note: note,
                        date: new Date()
                    };
                    
                    transaction.set(
                        db.collection(CENTERS_COLLECTION)
                            .doc(currentCenter.id)
                            .collection(MAINTENANCE_COLLECTION)
                            .doc(),
                        maintenanceRecord
                    );
                    
                    // تحديث عدد أعمال الصيانة للفني
                    const techRef = db.collection(TECHNICIANS_COLLECTION).doc(technicianId);
                    transaction.update(techRef, {
                        maintenanceCount: firebase.firestore.FieldValue.increment(1),
                        lastUpdated: new Date()
                    });
                });
                
                showNotification('تم تسجيل عملية الصيانة بنجاح', 'success');
                
                // إعادة تعيين الحقول
                document.getElementById('maintenance-item').value = '';
                document.getElementById('maintenance-quantity').value = '';
                document.getElementById('maintenance-customer-name').value = '';
                document.getElementById('maintenance-customer-phone').value = '';
                document.getElementById('device-name').value = '';
                document.getElementById('technician-select').value = '';
                document.getElementById('maintenance-note').value = '';
                
                // تحديث البيانات
                await loadCenterFromFirebase(currentCenter.id);
                await loadTechniciansFromFirebase();
                
            } catch (error) {
                console.error('Error recording maintenance:', error);
                showNotification(error.message || 'حدث خطأ أثناء تسجيل عملية الصيانة', 'error');
            }
        }
        
       // تصدير البيانات
async function exportData(type) {
    try {
        showNotification('جاري تصدير البيانات...', 'success');
        
        const exportScope = document.getElementById('export-scope').value;
        const selectedCenterId = document.getElementById('admin-center-select').value;
        
        let dataToExport = {
            exportDate: new Date().toISOString(),
            dataType: type,
            exportScope: exportScope
        };
        
        // تحديد المراكز التي سيتم تصدير بياناتها
        let centersToExport = [];
        if (exportScope === 'selected' && selectedCenterId && selectedCenterId !== 'all') {
            const center = centers.find(c => c.id === selectedCenterId);
            if (center) {
                centersToExport = [center];
                dataToExport.centerId = center.id;
                dataToExport.centerName = center.name;
            }
        } else {
            centersToExport = centers;
            dataToExport.centers = centers.map(c => ({ id: c.id, name: c.name }));
        }
        
        if (type === 'all' || type === 'inventory') {
            // تصدير المخزون
            dataToExport.inventory = [];
            for (const center of centersToExport) {
                const inventorySnapshot = await db.collection(CENTERS_COLLECTION).doc(center.id).collection(INVENTORY_COLLECTION).get();
                const centerInventory = inventorySnapshot.docs.map(doc => ({
                    ...doc.data(),
                    centerId: center.id,
                    centerName: center.name
                }));
                dataToExport.inventory = dataToExport.inventory.concat(centerInventory);
            }
        }
        
        if (type === 'all' || type === 'sales') {
            // تصدير المبيعات
            dataToExport.sales = [];
            for (const center of centersToExport) {
                const salesSnapshot = await db.collection(CENTERS_COLLECTION).doc(center.id).collection(SALES_COLLECTION).get();
                const centerSales = salesSnapshot.docs.map(doc => ({
                    ...doc.data(),
                    centerId: center.id,
                    centerName: center.name
                }));
                dataToExport.sales = dataToExport.sales.concat(centerSales);
            }
        }
        
        if (type === 'all' || type === 'maintenance') {
            // تصدير الصيانة
            dataToExport.maintenance = [];
            for (const center of centersToExport) {
                const maintenanceSnapshot = await db.collection(CENTERS_COLLECTION).doc(center.id).collection(MAINTENANCE_COLLECTION).get();
                const centerMaintenance = maintenanceSnapshot.docs.map(doc => ({
                    ...doc.data(),
                    centerId: center.id,
                    centerName: center.name
                }));
                dataToExport.maintenance = dataToExport.maintenance.concat(centerMaintenance);
            }
        }
        
        // تحويل البيانات إلى JSON
        const dataStr = JSON.stringify(dataToExport, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        
        // إنشاء عنصر تحميل
        const exportFileDefaultName = `export_${type}_${new Date().toISOString().split('T')[0]}.json`;
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
        
        showNotification(`تم تصدير بيانات ${type} بنجاح`, 'success');
    } catch (error) {
        console.error('Error exporting data:', error);
        showNotification('حدث خطأ أثناء تصدير البيانات', 'error');
    }
}
        // التبديل بين علامات التبويب
        function switchTab(tabId) {
            // إخفاء جميع محتويات علامات التبويب
            document.querySelectorAll('#app-container .tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // إلغاء تنشيط جميع علامات التبويب
            document.querySelectorAll('#app-container .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // تفعيل علامة التبويب المحددة
            document.getElementById(tabId).classList.add('active');
            
            // تفعيل زر علامة التبويب المحددة
            document.querySelector(`#app-container .tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
            
            // إذا كانت علامة التبويب هي الإعدادات، تحميل البيانات
            if (tabId === 'settings-tab') {
                loadSettingsData();
            }
        }
        
        // التبديل بين علامات التبويب في لوحة المسؤول
        function switchAdminTab(tabId) {
            // إخفاء جميع محتويات علامات التبويب
            document.querySelectorAll('#admin-container .tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // إلغاء تنشيط جميع علامات التبويب
            document.querySelectorAll('#admin-container .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // تفعيل علامة التبويب المحددة
            document.getElementById(tabId).classList.add('active');
            
            // تفعيل زر علامة التبويب المحددة
            document.querySelector(`#admin-container .tab[onclick="switchAdminTab('${tabId}')"]`).classList.add('active');
            
            // إذا كانت علامة التبويب هي الفنيين، تحميل البيانات
            if (tabId === 'technicians-tab') {
                updateAllTechniciansTable();
            }
            
            // إذا كانت علامة التبويب هي عرض البيانات، تحميل البيانات لجميع المراكز
            if (tabId === 'view-data-tab') {
                loadCenterDataForAdmin('all');
            }
        }
        
        // التبديل بين علامات التبويب في بيانات المركز
        function switchCenterDataTab(tabId) {
            // إخفاء جميع محتويات علامات التبويب
            document.querySelectorAll('#view-data-tab .tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // إلغاء تنشيط جميع علامات التبويب
            document.querySelectorAll('#view-data-tab .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // تفعيل علامة التبويب المحددة
            document.getElementById(tabId).classList.add('active');
            
            // تفعيل زر علامة التبويب المحددة
            document.querySelector(`#view-data-tab .tab[onclick="switchCenterDataTab('${tabId}')"]`).classList.add('active');
        }
        
        // عرض لوحة المسؤول
        function showAdminPanel() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('admin-container').style.display = 'block';
            
            // تحميل بيانات جميع المراكز عند فتح لوحة المسؤول
            loadCenterDataForAdmin('all');
        }
        
        // عرض تطبيق المركز
        // function showApp() {
        //     document.getElementById('login-page').style.display = 'none';
        //     document.getElementById('admin-container').style.display = 'none';
        //     document.getElementById('app-container').style.display = 'block';
            
        //     // تحديث واجهة المستخدم
        //     document.getElementById('center-header').textContent = currentCenter.name;
            
        //     // تحديث البيانات
        //     updateItemSelects();
        //     updateItemsTable();
        //     updateSalesTable();
        //     updateMaintenanceTable();
        //     updateInventorySummary();
        //     updateTechnicianSelects();
            
        // }
        // تحديث البيانات في واجهة المستخدم
function updateUI() {
    if (!currentCenter) return;
    
    // تحديث واجهة المستخدم
    document.getElementById('center-header').textContent = currentCenter.name;
    
    // تحديث البيانات فقط إذا كانت العناصر موجودة في DOM
    if (document.getElementById('items-table')) {
        updateItemSelects();
        updateItemsTable();
        updateInventorySummary();
    }
    
    if (document.getElementById('sales-table')) {
        updateSalesTable();
    }
    
    if (document.getElementById('maintenance-table')) {
        updateMaintenanceTable();
    }
    
    if (document.getElementById('technician-select')) {
        updateTechnicianSelects();
    }
}

// تحميل بيانات مركز من Firebase
async function loadCenterFromFirebase(centerId) {
    try {
        showNotification('جاري تحميل بيانات المركز...', 'success');
        
        // جلب بيانات المركز الأساسية
        const doc = await db.collection(CENTERS_COLLECTION).doc(centerId).get();
        if (!doc.exists) {
            showNotification('المركز غير موجود', 'error');
            return;
        }
        
        // جلب بيانات المخزون
        const inventorySnapshot = await db.collection(CENTERS_COLLECTION)
            .doc(centerId)
            .collection(INVENTORY_COLLECTION)
            .get();
        
        const inventory = [];
        inventorySnapshot.forEach(doc => {
            inventory.push({ id: doc.id, ...doc.data() });
        });
        
        // جلب بيانات المبيعات
        const salesSnapshot = await db.collection(CENTERS_COLLECTION)
            .doc(centerId)
            .collection(SALES_COLLECTION)
            .get();
        
        const sales = [];
        salesSnapshot.forEach(doc => {
            sales.push({ id: doc.id, ...doc.data() });
        });
        
        // جلب بيانات الصيانة
        const maintenanceSnapshot = await db.collection(CENTERS_COLLECTION)
            .doc(centerId)
            .collection(MAINTENANCE_COLLECTION)
            .get();
        
        const maintenance = [];
        maintenanceSnapshot.forEach(doc => {
            maintenance.push({ id: doc.id, ...doc.data() });
        });
        
        // تحديث البيانات المحلية
        currentCenter = { 
            id: doc.id, 
            ...doc.data(),
            inventory: inventory,
            sales: sales,
            maintenance: maintenance
        };
        
        localStorage.setItem('currentCenter', JSON.stringify(currentCenter));
        
        // تحديث واجهة المستخدم
        updateUI();
        
        showNotification('تم تحميل بيانات المركز بنجاح', 'success');
    } catch (error) {
        console.error('Error loading center:', error);
        showNotification('حدث خطأ في تحميل بيانات المركز', 'error');
    }
}

// عرض تطبيق المركز
function showApp() {
    document.getElementById('login-page').style.display = 'none';
    document.getElementById('admin-container').style.display = 'none';
    document.getElementById('app-container').style.display = 'block';
    
    // تحديث واجهة المستخدم
    updateUI();
}

// تحديث قوائم اختيار الأصناف
function updateItemSelects() {
    if (!currentCenter) return;
    
    const addItemSelect = document.getElementById('add-item');
    const saleItemSelect = document.getElementById('sale-item');
    const maintenanceItemSelect = document.getElementById('maintenance-item');
    
    // التحقق من وجود العناصر في DOM
    if (!addItemSelect || !saleItemSelect || !maintenanceItemSelect) return;
    
    // مسح القوائم الحالية
    addItemSelect.innerHTML = '<option value="">-- اختر صنف --</option>';
    saleItemSelect.innerHTML = '<option value="">-- اختر صنف --</option>';
    maintenanceItemSelect.innerHTML = '<option value="">-- اختر صنف --</option>';
    
    // إضافة الأصناف إلى القوائم
    if (currentCenter.inventory && currentCenter.inventory.length > 0) {
        currentCenter.inventory.forEach(item => {
            const option = document.createElement('option');
            option.value = item.id;
            option.textContent = item.name;
            
            if (addItemSelect) addItemSelect.appendChild(option.cloneNode(true));
            if (saleItemSelect) saleItemSelect.appendChild(option.cloneNode(true));
            if (maintenanceItemSelect) maintenanceItemSelect.appendChild(option.cloneNode(true));
        });
    }
}

// تحديث جدول الأصناف
function updateItemsTable() {
    if (!currentCenter) return;
    
    const tbody = document.querySelector('#items-table tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (currentCenter.inventory && currentCenter.inventory.length > 0) {
        currentCenter.inventory.forEach(item => {
            const row = document.createElement('tr');
            const value = item.quantity * item.price;
            
            row.innerHTML = `
                <td>${item.name}</td>
                <td>${item.quantity}</td>
                <td>${item.price.toFixed(2)} جنيه</td>
                <td>${value.toFixed(2)} جنيه</td>
                <td>${item.note || ''}</td>
            `;
            
            tbody.appendChild(row);
        });
    } else {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="5" style="text-align: center;">لا توجد أصناف في المخزون</td>`;
        tbody.appendChild(row);
    }
}

// تحديث جدول المبيعات
function updateSalesTable() {
    if (!currentCenter) return;
    
    const tbody = document.querySelector('#sales-table tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (currentCenter.sales && currentCenter.sales.length > 0) {
        // ترتيب المبيعات من الأحدث إلى الأقدم
        const sortedSales = [...currentCenter.sales].sort((a, b) => {
            return new Date(b.date) - new Date(a.date);
        });
        
        sortedSales.forEach(sale => {
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td>${new Date(sale.date).toLocaleString('ar-EG')}</td>
                <td>${sale.itemName}</td>
                <td>${sale.quantity}</td>
                <td>${sale.unitPrice ? sale.unitPrice.toFixed(2) : '0.00'} جنيه</td>
                <td>${sale.totalPrice ? sale.totalPrice.toFixed(2) : '0.00'} جنيه</td>
                <td>${sale.customerName || ''}</td>
                <td>${sale.customerPhone || ''}</td>
            `;
            
            tbody.appendChild(row);
        });
    } else {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="7" style="text-align: center;">لا توجد عمليات بيع</td>`;
        tbody.appendChild(row);
    }
}

// تحديث جدول الصيانة
function updateMaintenanceTable() {
    if (!currentCenter) return;
    
    const tbody = document.querySelector('#maintenance-table tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (currentCenter.maintenance && currentCenter.maintenance.length > 0) {
        // ترتيب طلبات الصيانة من الأحدث إلى الأقدم
        const sortedMaintenance = [...currentCenter.maintenance].sort((a, b) => {
            return new Date(b.date) - new Date(a.date);
        });
        
        sortedMaintenance.forEach(maintenance => {
            const row = document.createElement('tr');
            
            // تحديد فئة الحالة
            let statusClass = '';
            if (maintenance.status === 'في انتظار قطعة غيار') statusClass = 'status-waiting-part';
            else if (maintenance.status === 'في انتظار الفني') statusClass = 'status-waiting-technician';
            else if (maintenance.status === 'تم الصيانة') statusClass = 'status-completed';
            else if (maintenance.status === 'في انتظار العميل') statusClass = 'status-waiting-customer';
            
            row.innerHTML = `
                <td>${new Date(maintenance.date).toLocaleString('ar-EG')}</td>
                <td>${maintenance.itemName}</td>
                <td>${maintenance.quantity}</td>
                <td>${maintenance.customerName}<br>${maintenance.customerPhone}</td>
                <td>${maintenance.deviceName}</td>
                <td>${maintenance.technicianName}</td>
                <td><span class="maintenance-status ${statusClass}">${maintenance.status}</span></td>
            `;
            
            tbody.appendChild(row);
        });
    } else {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="7" style="text-align: center;">لا توجد طلبات صيانة</td>`;
        tbody.appendChild(row);
    }
}

// تحديث الإحصائيات
function updateInventorySummary() {
    if (!currentCenter) return;
    
    const totalItems = currentCenter.inventory ? currentCenter.inventory.length : 0;
    const totalQuantity = currentCenter.inventory ? currentCenter.inventory.reduce((sum, item) => sum + item.quantity, 0) : 0;
    const totalValue = currentCenter.inventory ? currentCenter.inventory.reduce((sum, item) => sum + (item.quantity * item.price), 0) : 0;
    const totalSales = currentCenter.sales ? currentCenter.sales.length : 0;
    const totalMaintenance = currentCenter.maintenance ? currentCenter.maintenance.length : 0;
    const totalSalesValue = currentCenter.sales ? currentCenter.sales.reduce((sum, sale) => sum + (sale.totalPrice || 0), 0) : 0;
    
    // تحديث العناصر فقط إذا كانت موجودة في DOM
    const totalItemsEl = document.getElementById('total-items');
    const totalQuantityEl = document.getElementById('total-quantity');
    const totalValueEl = document.getElementById('total-value');
    const totalSalesEl = document.getElementById('total-sales');
    const totalMaintenanceEl = document.getElementById('total-maintenance');
    const totalSalesValueEl = document.getElementById('total-sales-value');
    
    if (totalItemsEl) totalItemsEl.textContent = totalItems;
    if (totalQuantityEl) totalQuantityEl.textContent = totalQuantity;
    if (totalValueEl) totalValueEl.textContent = totalValue.toFixed(2);
    if (totalSalesEl) totalSalesEl.textContent = totalSales;
    if (totalMaintenanceEl) totalMaintenanceEl.textContent = totalMaintenance;
    if (totalSalesValueEl) totalSalesValueEl.textContent = totalSalesValue.toFixed(2);
}

// تحديث قوائم اختيار الفنيين
function updateTechnicianSelects() {
    const technicianSelect = document.getElementById('technician-select');
    if (!technicianSelect) return;
    
    // مسح القائمة الحالية
    technicianSelect.innerHTML = '<option value="">-- اختر الفني --</option>';
    
    // إضافة الفنيين إلى القائمة
    if (technicians && technicians.length > 0) {
        technicians.forEach(tech => {
            // عرض الفنيين المرتبطين بالمركز الحالي أو الفنيين العامين
            if (!tech.centerIds || tech.centerIds.includes(currentCenter.id)) {
                const option = document.createElement('option');
                option.value = tech.id;
                option.textContent = tech.name;
                technicianSelect.appendChild(option);
            }
        });
    }
}
        // عرض الإشعارات
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        // دوال الحذف (للمسؤول فقط)
        async function deleteItemAdmin(itemId, centerId) {
            if (!confirm('هل أنت متأكد من حذف هذا الصنف؟')) {
                return;
            }
            
            try {
                if (!centerId) {
                    showNotification('لا يمكن تحديد المركز', 'error');
                    return;
                }
                
                await db.collection(CENTERS_COLLECTION).doc(centerId).collection(INVENTORY_COLLECTION).doc(itemId).delete();
                showNotification('تم حذف الصنف بنجاح', 'success');
                
                // إعادة تحميل البيانات
                const currentCenterId = document.getElementById('admin-center-select').value;
                loadCenterDataForAdmin(currentCenterId);
            } catch (error) {
                console.error('Error deleting item:', error);
                showNotification('حدث خطأ أثناء حذف الصنف', 'error');
            }
        }
        
        async function deleteSaleAdmin(saleId, centerId) {
            if (!confirm('هل أنت متأكد من حذف عملية البيع هذه؟')) {
                return;
            }
            
            try {
                if (!centerId) {
                    showNotification('لا يمكن تحديد المركز', 'error');
                    return;
                }
                
                await db.collection(CENTERS_COLLECTION).doc(centerId).collection(SALES_COLLECTION).doc(saleId).delete();
                showNotification('تم حذف عملية البيع بنجاح', 'success');
                
                // إعادة تحميل البيانات
                const currentCenterId = document.getElementById('admin-center-select').value;
                loadCenterDataForAdmin(currentCenterId);
            } catch (error) {
                console.error('Error deleting sale:', error);
                showNotification('حدث خطأ أثناء حذف عملية البيع', 'error');
            }
        }
        
        async function deleteMaintenanceAdmin(maintenanceId, centerId) {
            if (!confirm('هل أنت متأكد من حذف عملية الصيانة هذه؟')) {
                return;
            }
            
            try {
                if (!centerId) {
                    showNotification('لا يمكن تحديد المركز', 'error');
                    return;
                }
                
                await db.collection(CENTERS_COLLECTION).doc(centerId).collection(MAINTENANCE_COLLECTION).doc(maintenanceId).delete();
                showNotification('تم حذف عملية الصيانة بنجاح', 'success');
                
                // إعادة تحميل البيانات
                const currentCenterId = document.getElementById('admin-center-select').value;
                loadCenterDataForAdmin(currentCenterId);
            } catch (error) {
                console.error('Error deleting maintenance:', error);
                showNotification('حدث خطأ أثناء حذف عملية الصيانة', 'error');
            }
        }
        
      
        
       
        // تهيئة الصفحة عند التحميل
        document.addEventListener('DOMContentLoaded', initializePage);
        
        // إضافة حدث عند تغيير اختيار المركز في لوحة المسؤول
        document.getElementById('admin-center-select').addEventListener('change', function() {
            const centerId = this.value;
            if (centerId) {
                loadCenterDataForAdmin(centerId);
            }
        });
    </script>
</body>
</html>
